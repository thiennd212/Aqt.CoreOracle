---
description: 
globs: **/Aqt.CoreOracle.EntityFrameworkCore/**/*.cs
alwaysApply: false
---
# Rule: Chuáº©n hÃ³a táº§ng Aqt.CoreOracle.EntityFrameworkCore

## Context

Táº§ng `EntityFrameworkCore` lÃ  nÆ¡i Ä‘á»‹nh nghÄ©a DbContext, cáº¥u hÃ¬nh mapping vÃ  implement Repository.  
ÄÃ¢y lÃ  cáº§u ná»‘i giá»¯a táº§ng Domain vÃ  Database, dÃ¹ng Ä‘á»ƒ hiá»‡n thá»±c hÃ³a há»£p Ä‘á»“ng Repository Ä‘Ã£ khai bÃ¡o á»Ÿ `Domain`.

## Requirements

### ğŸ“ Cáº¥u trÃºc thÆ° má»¥c

- âœ… Theo module: `Orders/OrderRepository.cs`, `Customers/CustomerRepository.cs`
- âœ… Chá»©a mapping táº¡i `EntityFrameworkCore/EntityTypeConfigurations/`
- âŒ KhÃ´ng nÃªn chá»©a Entity, AppService, logic nghiá»‡p vá»¥

### ğŸ“¦ Namespace

- âœ… `Aqt.CoreOracle.EntityFrameworkCore.[Module]`
- âŒ KhÃ´ng dÃ¹ng `Application`, `Domain`, `Web`

### ğŸ§© DbContext

- âœ… DbContext káº¿ thá»«a tá»« `AbpDbContext<CoreOracleDbContext>`
- âœ… Khai bÃ¡o `DbSet<T>` theo tá»«ng Entity
- âœ… Override `OnModelCreating` Ä‘á»ƒ configure entity náº¿u cáº§n

ğŸ“Œ VÃ­ dá»¥:
```csharp
public class CoreOracleDbContext : AbpDbContext<CoreOracleDbContext>
{
    public DbSet<Order> Orders { get; set; }

    public CoreOracleDbContext(DbContextOptions<CoreOracleDbContext> options)
        : base(options) {}

    protected override void OnModelCreating(ModelBuilder builder)
    {
        base.OnModelCreating(builder);
        builder.ConfigureCoreOracle(); // Extension method cho module nÃ y
    }
}
```

### ğŸ—ƒï¸ Repository Implementation

- âœ… Repository implement tá»« interface á»Ÿ Domain (VD: `IOrderRepository`)
- âœ… Káº¿ thá»«a `EfCoreRepository<DbContext, Entity, Key>`
- âœ… Äáº·t táº¡i module tÆ°Æ¡ng á»©ng trong EntityFrameworkCore

ğŸ“Œ VÃ­ dá»¥:
```csharp
public class OrderRepository : EfCoreRepository<CoreOracleDbContext, Order, Guid>, IOrderRepository
{
    public OrderRepository(IDbContextProvider<CoreOracleDbContext> dbContextProvider)
        : base(dbContextProvider)
    {
    }

    public Task<List<Order>> GetRecentAsync(int count)
    {
        return (await GetDbSetAsync())
            .OrderByDescending(x => x.CreationTime)
            .Take(count)
            .ToListAsync();
    }
}
```

### ğŸ§© Entity Mapping
---

### ğŸ—‚ï¸ EntityTypeConfiguration tÃ¡ch riÃªng

ABP cho phÃ©p báº¡n cáº¥u hÃ¬nh entity báº±ng Fluent API theo 2 cÃ¡ch:

1. Cáº¥u hÃ¬nh trá»±c tiáº¿p trong `CoreOracleDbContextModelCreatingExtensions` (chá»‰ nÃªn dÃ¹ng cho cáº¥u hÃ¬nh chung, Ä‘Æ¡n giáº£n)
2. âœ… **Khuyáº¿n nghá»‹:** táº¡o class riÃªng implement `IEntityTypeConfiguration<TEntity>` cho tá»«ng entity â†’ tÃ¡ch biá»‡t, dá»… maintain, rÃµ vai trÃ².

#### âœ… Quy táº¯c:
- âœ… Má»—i entity nÃªn cÃ³ má»™t file riÃªng káº¿ thá»«a `IEntityTypeConfiguration<T>`
- âœ… Äáº·t trong thÆ° má»¥c `EntityFrameworkCore/Configurations/`
- âœ… ÄÄƒng kÃ½ báº±ng `builder.ApplyConfiguration(new OrderConfiguration());` trong `CoreOracleDbContextModelCreatingExtensions`

ğŸ“Œ VÃ­ dá»¥:

```csharp
public class OrderConfiguration : IEntityTypeConfiguration<Order>
{
    public void Configure(EntityTypeBuilder<Order> builder)
    {
        builder.ToTable("Orders", "app");
        builder.ConfigureByConvention();
        builder.Property(x => x.Code).IsRequired().HasMaxLength(64);
    }
}
```

ğŸ“Œ Trong `CoreOracleDbContextModelCreatingExtensions.cs`:
```csharp
builder.ApplyConfiguration(new OrderConfiguration());
```

> âŒ KhÃ´ng nÃªn dá»“n toÃ n bá»™ cáº¥u hÃ¬nh cá»§a tá»«ng entity vÃ o 1 file extension lá»›n, gÃ¢y khÃ³ báº£o trÃ¬.


- âœ… TÃ¡ch riÃªng file mapping náº¿u entity cÃ³ cáº¥u hÃ¬nh phá»©c táº¡p
- âœ… DÃ¹ng Fluent API trong `Configure<Entity>(...)`
- âœ… Extension method `ModelBuilder.ConfigureCoreOracle()` nÃªn gá»i táº¡i `OnModelCreating`

ğŸ“Œ VÃ­ dá»¥:
```csharp
public static class CoreOracleDbContextModelCreatingExtensions
{
    public static void ConfigureCoreOracle(this ModelBuilder builder)
    {
        builder.Entity<Order>(b =>
        {
            b.ToTable("Orders", "app");
            b.ConfigureByConvention();
            b.Property(x => x.Code).IsRequired().HasMaxLength(64);
        });
    }
}
```

### ğŸ§¾ Using Ä‘Ãºng namespace

Cáº§n `using` Ä‘Ãºng cÃ¡c namespace sau Ä‘á»ƒ truy cáº­p Setting, Localization

| Loáº¡i dá»¯ liá»‡u          | Namespace máº«u                                               |
|-----------------------|-------------------------------------------------------------|
| Setting name constant | `Aqt.CoreOracle.Settings`                                   |
| Localization Resource | `Aqt.CoreOracle.Localization`                               |

ğŸ“Œ VÃ­ dá»¥:
```csharp
using Aqt.CoreOracle.Permissions;
using Aqt.CoreOracle.Settings;
using Aqt.CoreOracle.Localization;
```

## Examples

### âœ… VÃ­ dá»¥ Ä‘Ãºng

```csharp
// ğŸ§© DbContext Ä‘Ãºng chuáº©n ABP
public class CoreOracleDbContext : AbpDbContext<CoreOracleDbContext>
{
    public DbSet<Order> Orders { get; set; }

    public CoreOracleDbContext(DbContextOptions<CoreOracleDbContext> options)
        : base(options) {}

    protected override void OnModelCreating(ModelBuilder builder)
    {
        base.OnModelCreating(builder);
        builder.ConfigureCoreOracle();
    }
}
```

```csharp
// ğŸ—ƒï¸ Repository implement Ä‘Ãºng chuáº©n
public class OrderRepository : EfCoreRepository<CoreOracleDbContext, Order, Guid>, IOrderRepository
{
    public OrderRepository(IDbContextProvider<CoreOracleDbContext> provider) : base(provider) { }
}
```

### âŒ VÃ­ dá»¥ sai

```csharp
// âŒ KhÃ´ng káº¿ thá»«a AbpDbContext
public class BadDbContext : DbContext
{
    public DbSet<Order> Orders { get; set; }
}

// âŒ Repository khÃ´ng implement interface
public class OrderRepo
{
    // thiáº¿u káº¿ thá»«a tá»« EfCoreRepository, sai chuáº©n
}
```
