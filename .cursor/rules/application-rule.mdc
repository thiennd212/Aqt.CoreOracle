---
description: 
globs: **/Aqt.CoreOracle.Application/**/*.cs
alwaysApply: false
---
# Rule: Chuáº©n hÃ³a táº§ng Aqt.CoreOracle.Application

## Context

Táº§ng `Application` chá»©a toÃ n bá»™ **xá»­ lÃ½ nghiá»‡p vá»¥ á»©ng dá»¥ng**, Ä‘Æ°á»£c tá»• chá»©c theo `AppService`, sá»­ dá»¥ng DTO tá»« `Application.Contracts`, tÆ°Æ¡ng tÃ¡c vá»›i `Domain` vÃ  `Repository`.  
ÄÃ¢y lÃ  nÆ¡i triá»ƒn khai cÃ¡c phÆ°Æ¡ng thá»©c Ä‘Æ°á»£c expose ra ngoÃ i qua API, UI hoáº·c Client.

## Requirements

### ğŸ“ Cáº¥u trÃºc thÆ° má»¥c

- âœ… Tá»• chá»©c theo module: `Orders/OrderAppService.cs`, `Customers/CustomerAppService.cs`
- âœ… PhÃ¢n tÃ¡ch rÃµ cÃ¡c `Managers/`, `Services/`, `AppServices/`
- âŒ KhÃ´ng chá»©a DTO, Permission constant â†’ náº±m trong Application.Contracts

### ğŸ“¦ Namespace

- âœ… Format: `Aqt.CoreOracle.Application.[Module]`
- âŒ KhÃ´ng dÃ¹ng láº«n vá»›i `Contracts`, `Domain`, `HttpApi`

### ğŸ”§ AppService

Trong ABP Framework, AppService cÃ³ thá»ƒ káº¿ thá»«a tá»«:

| Base Class                     | Khi nÃ o dÃ¹ng?                                    |
|--------------------------------|--------------------------------------------------|
| `ApplicationService`           | DÃ¹ng khi cáº§n viáº¿t logic tÃ¹y chá»‰nh                |
| `CrudAppService<TEntity, Dto>` | DÃ¹ng khi muá»‘n CRUD nhanh gá»n theo convention ABP |

NgoÃ i ra, **má»i AppService pháº£i implement interface Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong Application.Contracts**.

#### âœ… Quy táº¯c:

- âœ… AppService **pháº£i káº¿ thá»«a** tá»« `ApplicationService` hoáº·c `CrudAppService`
- âœ… AppService **pháº£i implement interface** tÆ°Æ¡ng á»©ng trong `Application.Contracts`
- âœ… Interface pháº£i káº¿ thá»«a `IApplicationService` hoáº·c `ICrudAppService`
- âŒ KhÃ´ng nÃªn viáº¿t AppService mÃ  khÃ´ng cÃ³ interface
- âŒ KhÃ´ng nÃªn káº¿ thá»«a cáº£ `ApplicationService` vÃ  `CrudAppService` cÃ¹ng lÃºc

ğŸ“Œ VÃ­ dá»¥:

```csharp
// DÃ¹ng ApplicationService khi cáº§n custom logic
public interface IOrderAppService : IApplicationService
{
    Task<OrderDto> GetAsync(Guid id);
}

public class OrderAppService : ApplicationService, IOrderAppService
{
    public async Task<OrderDto> GetAsync(Guid id) => ...;
}

// DÃ¹ng CrudAppService khi CRUD Ä‘Æ¡n giáº£n
public interface IProductAppService : ICrudAppService<ProductDto, Guid> { }

public class ProductAppService : CrudAppService<Product, ProductDto, Guid>, IProductAppService
{
    public ProductAppService(IRepository<Product, Guid> repo) : base(repo) { }
}
```

### ğŸ§  Business Logic

- âœ… CÃ³ thá»ƒ xá»­ lÃ½ tÃ­nh toÃ¡n nghiá»‡p vá»¥, orchestrate domain, validate dá»¯ liá»‡u
- âŒ KhÃ´ng thao tÃ¡c trá»±c tiáº¿p vá»›i DbContext
- âŒ KhÃ´ng raise Domain Event (pháº£i raise tá»« Entity hoáº·c Domain)

### ğŸ§­ Cáº¥u hÃ¬nh AutoMapper Profile
#### ğŸ› ï¸ Sá»­ dá»¥ng `.ForMember(...)` náº¿u cáº§n Ã¡nh xáº¡ Ä‘áº·c biá»‡t

Náº¿u field trong DTO vÃ  Entity khÃ´ng trÃ¹ng tÃªn, hoáº·c cáº§n xá»­ lÃ½ tÃ¹y biáº¿n khi map, dÃ¹ng `.ForMember(...)` Ä‘á»ƒ Ä‘á»‹nh nghÄ©a rÃµ.

ğŸ“Œ VÃ­ dá»¥:
```csharp
CreateMap<Order, OrderDto>()
    .ForMember(dest => dest.TotalText, opt => opt.MapFrom(src => src.Total.ToString("C0")));

CreateMap<CreateUpdateOrderDto, Order>()
    .ForMember(dest => dest.Status, opt => opt.Ignore()); // bá» qua trÆ°á»ng khÃ´ng cáº§n map
```

> âœ… `.ForMember` lÃ  cÃ¡ch tá»‘t nháº¥t Ä‘á»ƒ custom mapping chÃ­nh xÃ¡c trong AutoMapper profile.


Äá»ƒ Ã¡nh xáº¡ DTO â†” Entity má»™t cÃ¡ch tá»± Ä‘á»™ng, báº¡n nÃªn táº¡o class cáº¥u hÃ¬nh AutoMapper profile riÃªng cho tá»«ng module.

#### âœ… Quy táº¯c:
- âœ… Má»—i module nÃªn cÃ³ má»™t profile riÃªng: `OrderApplicationAutoMapperProfile`
- âœ… Káº¿ thá»«a tá»« `Profile` (AutoMapper) hoáº·c `AutoMapperProfileBase` (náº¿u dÃ¹ng base ABP)
- âœ… ÄÄƒng kÃ½ trong `ApplicationModule` qua `AddAutoMapperObjectMapper`
- âŒ KhÃ´ng khai bÃ¡o mapping trong AppService trá»±c tiáº¿p

ğŸ“Œ VÃ­ dá»¥:

```csharp
public class OrderApplicationAutoMapperProfile : Profile
{
    public OrderApplicationAutoMapperProfile()
    {
        CreateMap<Order, OrderDto>();
        CreateMap<CreateUpdateOrderDto, Order>();
    }
}
```

ğŸ“Œ Trong `AqtCoreOracleApplicationModule.cs`:
```csharp
context.Services.AddAutoMapperObjectMapper<AqtCoreOracleApplicationModule>();
Configure<AbpAutoMapperOptions>(options =>
{
    options.AddMaps<AqtCoreOracleApplicationModule>();
});
```

### ğŸ“¤ Káº¿t ná»‘i táº§ng ngoÃ i

- âœ… DÃ¹ng AutoMapper Ä‘á»ƒ map DTO <-> Entity
- âœ… Gá»i repository, domain service, setting provider, permission checker náº¿u cáº§n

### ğŸ” Sá»­ dá»¥ng AutoMapper trong Application

AppService nÃªn sá»­ dá»¥ng `ObjectMapper.Map<>()` Ä‘á»ƒ Ã¡nh xáº¡ DTO â†” Entity.

#### âœ… Quy táº¯c:
- âœ… DÃ¹ng `ObjectMapper.Map<DTO, Entity>()` khi táº¡o má»›i entity tá»« dá»¯ liá»‡u Ä‘áº§u vÃ o
- âœ… Sá»­ dá»¥ng phÆ°Æ¡ng thá»©c ConstructUsing trong cáº¥u hÃ¬nh AutoMapper Ä‘á»ƒ khá»Ÿi táº¡o Id trong quÃ¡ trÃ¬nh Ã¡nh xáº¡ vá»›i CreateDto
- âœ… DÃ¹ng `ObjectMapper.Map<Entity, DTO>()` khi tráº£ káº¿t quáº£ ra ngoÃ i
- âœ… DÃ¹ng `MapList<>()` Ä‘á»ƒ map danh sÃ¡ch náº¿u cáº§n
- âŒ KhÃ´ng Ã¡nh xáº¡ thá»§ cÃ´ng náº¿u DTO/Entity cÃ³ nhiá»u trÆ°á»ng

ğŸ“Œ VÃ­ dá»¥:

```csharp
public async Task<OrderDto> GetAsync(Guid id)
{
    var entity = await _orderRepository.GetAsync(id);
    return ObjectMapper.Map<Order, OrderDto>(entity);
}

public async Task CreateAsync(CreateOrderDto input)
{
	input.
    var entity = ObjectMapper.Map<CreateOrderDto, Order>(input);
    await _orderRepository.InsertAsync(entity);
}
```

### ğŸ§¾ Using Ä‘Ãºng namespace

Cáº§n `using` Ä‘Ãºng cÃ¡c namespace sau Ä‘á»ƒ truy cáº­p AppService interface, DTO, Permissions, Constants, Enum, v.v.

| Loáº¡i dá»¯ liá»‡u          | Namespace máº«u                                               |
|-----------------------|-------------------------------------------------------------|
| AppService interface  | `Aqt.CoreOracle.Application.Contracts.[Module]`             |
| DTO                   | `Aqt.CoreOracle.Application.Contracts.[Module].Dtos`        |
| Enum                  | `Aqt.CoreOracle.Domain.Shared.Enums`                        |
| Permission            | `Aqt.CoreOracle.Permissions`                                |
| Setting name constant | `Aqt.CoreOracle.Settings`                                   |
| Localization Resource | `Aqt.CoreOracle.Localization`                               |

ğŸ“Œ VÃ­ dá»¥:
```csharp
using Aqt.CoreOracle.Application.Contracts.Orders;
using Aqt.CoreOracle.Application.Contracts.Orders.Dtos;
using Aqt.CoreOracle.Domain.Shared.Enums;
using Aqt.CoreOracle.Permissions;
using Aqt.CoreOracle.Settings;
using Aqt.CoreOracle.Localization;
```

## Examples

### âœ… VÃ­ dá»¥ Ä‘Ãºng

// ğŸ”§ AppService káº¿ thá»«a ApplicationService
namespace Aqt.CoreOracle.Application.Orders;

public class OrderAppService : ApplicationService, IOrderAppService
{
    private readonly IOrderRepository _orderRepository;

    public OrderAppService(IOrderRepository orderRepository)
    {
        _orderRepository = orderRepository;
    }

    public async Task<OrderDto> GetAsync(Guid id)
    {
        var order = await _orderRepository.GetAsync(id);
        return ObjectMapper.Map<Order, OrderDto>(order);
    }
}

### âŒ VÃ­ dá»¥ sai

// âŒ AppService gá»i trá»±c tiáº¿p DbContext
public class BadAppService : ApplicationService
{
    private readonly MyDbContext _context;
    public BadAppService(MyDbContext context) => _context = context;

    public async Task<List<Order>> GetAll() => await _context.Orders.ToListAsync(); // âŒ
}

// âŒ AppService raise event (sai táº§ng)
public class BadOrderAppService : ApplicationService
{
    public void Complete(Guid id)
    {
        var order = new Order();
        AddDomainEvent(new OrderCompletedEvent(order.Id)); // âŒ sai
    }
}
